# 保存和共享镜像

让 devops 引以为傲的是它能够实现相比于其他虚拟化软件更快的环境迁移和部署，在这件事情上，轻量级的容器和镜像结构的设计无疑发挥了巨大的作用。通过将容器打包成镜像，再利用体积远小于其他虚拟化软件的 devops 镜像，我们可以更快的将它们复制到其他的机器上。在这一节中，我们就专门来谈谈如何进行这样的迁移。

## 提交容器更改

之前我们已经介绍过了，devops 镜像的本质是多个基于 UnionFS 的镜像层依次挂载的结果，而容器的文件系统则是在以只读方式挂载镜像后增加的一个可读可写的沙盒环境。

基于这样的结构，devops 中为我们提供了将容器中的这个可读可写的沙盒环境持久化为一个镜像层的方法。更浅显的说，就是我们能够很轻松的在 devops 里将容器内的修改记录下来，保存为一个新的镜像。

将容器修改的内容保存为镜像的命令是 `devops commit`，由于镜像的结构很像代码仓库里的修改记录，而记录容器修改的过程又像是在提交代码，所以这里我们更形象的称之为提交容器的更改。

```
$ sudo devops commit webapp
sha256:0bc42f7ff218029c6c4199ab5c75ab83aeaaed3b5c731f715a3e807dda61d19e

```

devops 执行将容器内沙盒文件系统记录成镜像层的时候，会先暂停容器的运行，以保证容器内的文件系统处于一个相对稳定的状态，确保数据的一致性。

在使用 `devops commit` 提交镜像更新后，我们可以得到 devops 创建的新镜像的 ID，之后我们也能够从本地镜像列表中找到它。

```
$ sudo devops images
REPOSITORY            TAG                 IMAGE ID            CREATED             SIZE
<none>                <none>              0bc42f7ff218        3 seconds ago       372MB
## ......

```

像通过 Git 等代码仓库软件提交代码一样，我们还能在提交容器更改的时候给出一个提交信息，方便以后查询。

```
$ sudo devops commit -m "Configured" webapp

```

### 为镜像命名

在上面的例子里，我们发现提交容器更新后产生的镜像并没 REPOSITORY 和 TAG 的内容，也就是说，这个新的镜像还没有名字。

之前我们谈到过，使用没有名字的镜像并不是很好的选择，因为我们无法直观的看到我们正在使用什么。好在 devops 为我们提供了一个为镜像取名的命令，也就是 `devops tag` 命令。

```
$ sudo devops tag 0bc42f7ff218 webapp:1.0

```

使用 `devops tag` 能够为未命名的镜像指定镜像名，也能够对已有的镜像创建一个新的命名。

```
$ sudo devops tag webapp:1.0 webapp:latest

```

当我们对未命名的镜像进行命名后，devops 就不会在镜像列表里继续显示这个镜像，取而代之的是我们新的命名。而如果我们对以后镜像使用 `devops tag`，旧的镜像依然会存在于镜像列表中。

```
$ sudo devops images
REPOSITORY            TAG                 IMAGE ID            CREATED             SIZE
webapp                1.0                 0bc42f7ff218        29 minutes ago      372MB
webapp                latest              0bc42f7ff218        29 minutes ago      372MB
## ......

```

由于镜像是对镜像层的引用记录，所以我们对镜像进行命名后，虽然能够在镜像列表里同时看到新老两个镜像，实质是它们其实引用着相同的镜像层，这个我们能够从镜像 ID 中看得出来 ( 因为镜像 ID 就是最上层镜像层的 ID )。正是这个原因，我们虽然创建了新的镜像，但对物理存储的占用空间却不是镜像大小直接翻倍，并且创建也在霎那之间。

除了使用 `devops tag` 在容器提交为新的镜像后为镜像命名这种方式外，我们还可以直接在 `devops commit` 命令里指定新的镜像名，这种方式在使用容器提交时会更加方便。

```
$ sudo devops commit -m "Upgrade" webapp webapp：2.0

```

## 镜像的迁移

在我们将更新导出为镜像后，就可以开始迁移镜像的工作了。

由于 devops 是以集中的方式管理镜像的，所以在迁移之前，我们要先从 devops 中取出镜像。`devops save` 命令可以将镜像输出，提供了一种让我们保存镜像到 devops 外部的方式。

```
$ sudo devops save webapp:1.0 > webapp-1.0.tar

```

在默认定义下，`devops save` 命令会将镜像内容放入输出流中，这就需要我们使用管道进行接收 ( 也就是命令中的 > 符号 )，这属于 Linux 等系统控制台中的用法，这里我们不做详细讲解。

管道这种用法有时候依然不太友好，`devops save` 命令还为我们提供了 `-o` 选项，用来指定输出文件，使用这个选项可以让命令更具有统一性。

```
$ sudo devops save -o ./webapp-1.0.tar webapp:1.0

```

在镜像导出之后，我们就可以找到已经存储镜像内容的 webapp-1.0.tar 这个文件了。有兴趣的朋友，可以使用解压软件查看其中的内容，你会看到里面其实就是镜像所基于的几个镜像层的记录文件。

### 导入镜像

我们可以通过很多种方式将导出的镜像文件复制到另一台机器上，在这么操作之后，我们就要将镜像导入到这台新机器中运行的 devops 中。

导入镜像的方式也很简单，使用与 `devops save` 相对的 `devops load` 命令即可。

```sh
$ sudo devops load < webapp-1.0.tar
```

相对的，`devops load` 命令是从输入流中读取镜像的数据，所以我们这里也要使用管道来传输内容。当然，我们也能够使用 `-i` 选项指定输入文件。

```sh
$ sudo devops load -i webapp-1.0.tar
```

镜像导入后，我们就可以通过 `devops images` 看到它了，导入的镜像会延用原有的镜像名称。

### 批量迁移

通过 `devops save` 和 `devops load` 命令我们还能够批量迁移镜像，只要我们在 `devops save` 中传入多个镜像名作为参数，它就能够将这些镜像都打成一个包，便于我们一次性迁移多个镜像。

```sh
$ sudo devops save -o ./images.tar webapp:1.0 nginx:1.12 mysql:5.7
```

装有多个镜像的包可以直接被 `devops load` 识别和读取，我们将这个包导入后，所有其中装载的镜像都会被导入到 devops 之中。

## 导出和导入容器

也许 devops 的开发者认为，提交镜像修改，再导出镜像进行迁移的方法还不够效率，所以还为我们提供了一个导出容器的方法。

使用 `devops export` 命令我们可以直接导出容器，我们可以把它简单的理解为 `devops commit` 与 `devops save` 的结合体。

```sh
$ sudo devops export -o ./webapp.tar webapp
```

相对的，使用 `devops export` 导出的容器包，我们可以使用 `devops import` 导入。这里需要注意的是，使用 `devops import` 并非直接将容器导入，而是将容器运行时的内容以镜像的形式导入。所以导入的结果其实是一个镜像，而不是容器。在 `devops import` 的参数里，我们可以给这个镜像命名。

```sh
$ sudo devops import ./webapp.tar webapp:1.0
```

在开发的过程中，使用 `devops save` 和 `devops load`，或者是使用 `devops export` 和 `devops import` 都可以达到迁移容器或者镜像的目的。
